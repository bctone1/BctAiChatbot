<?php
/*
*Plugin Name:       BCT AI Chatbot
*Description:       ChatGPT, Embeddings, AI Training, STT/TTS, Custom Post Types
*Version:           0.8.3
*Author:            Bctone
*Author URI:        https://bctaichatbot.com/
*License:           GPL-2.0+
*License URI:       https://www.gnu.org/licenses/gpl-2.0.html
*Text Domain:       bctai
*Domain Path:       /languages
*/
if ( !defined( 'WPINC' ) ) {
    die;
}
define( 'WP_BCT_AI_VERSION', '0.8.3' );
if( !class_exists( '\\BCTAI\\BCTAI_OpenAI' ) ) {
    require_once __DIR__ . '/includes/class-wp-bct-ai-openai.php';
}
if ( ! function_exists( 'bct_fs' ) ) {
    // Create a helper function for easy SDK access.
    function bct_fs() {
        global $bct_fs;

        if ( ! isset( $bct_fs ) ) {
            // Include Freemius SDK.
            require_once dirname(__FILE__) . '/freemius/start.php';

            $bct_fs = fs_dynamic_init( array(
                'id'                  => '15409',
                'slug'                => 'bctai',
                'premium_slug'        => 'bctchatbot-premium',
                'type'                => 'plugin',
                'public_key'          => 'pk_68f1d4ad1f4ad58b208fc68574689',
                'is_premium'          => false,
                // If your plugin is a serviceware, set this option to false.
                //'has_premium_version' => true,
                'has_addons'          => false,
                'has_paid_plans'      => true,
                'menu'                => array(
                    'slug'           => 'bctaichat',
                    'first-path'     => 'admin.php?page=bctaichat',
                    'contact'        => false,
                    'support'        => false,
                ),
                'is_live'        => true,
            ) );
        }

        return $bct_fs;
    }

    // Init Freemius.
    bct_fs();
    // Signal that SDK was initiated.
    do_action( 'bct_fs_loaded' );
}

global $wpdb;
$bctai_visitor_count = $wpdb->prefix . 'bctai_visitor_count';

if ($wpdb->get_var($wpdb->prepare("SHOW TABLES LIKE %s", $bctai_visitor_count)) != $bctai_visitor_count) {
    $charset_collate = $wpdb->get_charset_collate();

    $sql = "CREATE TABLE " . $bctai_visitor_count . "(
        `id` mediumint(11) NOT NULL AUTO_INCREMENT,
        `session` VARCHAR(255) NOT NULL,
        `page_user` VARCHAR(255) NOT NULL,
        `page_url` VARCHAR(255) NOT NULL,
        `time` INT NOT NULL,
        PRIMARY KEY (id)
        ) $charset_collate";
    $wpdb->query($sql);
}









function activate_wp_bct_ai()
{
    require_once plugin_dir_path( __FILE__ ) . 'includes/class-wp-bct-ai-activator.php';
    Wp_BCT_Ai_Activator::activate();
}
function deactivate_wp_bct_ai()
{
    require_once plugin_dir_path( __FILE__ ) . 'includes/class-wp-bct-ai-deactivator.php';
    Wp_BCT_Ai_Deactivator::deactivate();
}
function uninstall_wp_bct_ai(){
    
    global $wpdb;

    
    $site_options = $wpdb->get_results( "SELECT option_name FROM {$wpdb->options} WHERE option_name LIKE 'bctai%'" );
    foreach ($site_options as $option) {

        $option_name = $option->option_name;
        delete_option($option_name);
        delete_site_option($option_name);
    }

    $site_options2 = $wpdb->get_results( "SELECT option_name FROM {$wpdb->options} WHERE option_name LIKE '_bctai%'" );
    foreach ($site_options2 as $option) {

        $option_name = $option->option_name;
        delete_option($option_name);
        delete_site_option($option_name);
    }


    $wpdb->query( "DROP TABLE IF EXISTS {$wpdb->prefix}bctai" );
    $wpdb->query( "DROP TABLE IF EXISTS {$wpdb->prefix}bctai_audio_logs" );
    $wpdb->query( "DROP TABLE IF EXISTS {$wpdb->prefix}bctai_chatlogs" );
    $wpdb->query( "DROP TABLE IF EXISTS {$wpdb->prefix}bctai_chattokens" );
    $wpdb->query( "DROP TABLE IF EXISTS {$wpdb->prefix}bctai_visitor_count" );

    // $wpdb->query( "DROP TABLE IF EXISTS {$wpdb->prefix}bctai_form_logs" );
    // $wpdb->query( "DROP TABLE IF EXISTS {$wpdb->prefix}bctai_formtokens" );
    // $wpdb->query( "DROP TABLE IF EXISTS {$wpdb->prefix}bctai_promptbase_logs" );
    
}


register_activation_hook( __FILE__, 'activate_wp_bct_ai' );

register_deactivation_hook( __FILE__, 'deactivate_wp_bct_ai' );

register_uninstall_hook( __FILE__, 'uninstall_wp_bct_ai' );

require plugin_dir_path( __FILE__ ) . '/includes/class-wp-bct-ai.php';

function run_wp_bct_ai()
{
    $plugin = new Wp_BCT_Ai();
    $plugin->run();
}

function load_bctai_plugin_textdomain() {
    load_plugin_textdomain( 'bctai', false, dirname( plugin_basename( __FILE__ ) ) . '/languages' );
}
add_action( 'plugins_loaded', 'load_bctai_plugin_textdomain' );


run_wp_bct_ai();

require_once __DIR__ . '/bct-ai-extra.php';
