function start(e){if(isRecognizing)return console.log("====종료===="),e.innerHTML="",e.innerHTML=bctaiMicIcon,e.classList.remove("bctai-recording"),void recognition.stop();console.log("====시작===="),e.innerHTML="",e.innerHTML=bctaiStopIcon,e.classList.add("bctai-recording"),recognition.lang=language,recognition.start()}function formatAMPM(e){var t=e.getHours(),a=e.getMinutes(),i=t>=12?"PM":"AM";t%=12,t=t||12,a=a<10?"0"+a:a;var n=t+":"+a+" "+i;return n}function bctaiescapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function bctaistartChatRecording(){let e={audio:!0,video:!1};navigator.mediaDevices.getUserMedia(e).then(function(e){bctaiaudioContext=new bctaiChatAudioContext,bctaiChatStream=e,bctaiInput=bctaiaudioContext.createMediaStreamSource(e),bctaiChatRec=new Recorder(bctaiInput,{numChannels:1}),bctaiChatRec.record()})}function bctaistopChatRecording(e){bctaiChatRec.stop(),bctaiChatStream.getAudioTracks()[0].stop(),bctaiChatRec.exportWAV(function(t){console.log(t);let a,i,n,c=e.getAttribute("data-type");"widget"===c?(a=e.closest(".bctai-chatbox"),i=a.querySelectorAll(".chatbot-contents")[0],n=a.querySelectorAll(".bctai-chat-widget-typing")[0]):(a=e.closest(".bctai-chatbox"),i=a.querySelectorAll(".chatbot-contents")[0],n=a.querySelectorAll(".bctai-chat-shortcode-typing")[0]),bctaiSendChatMessage(a,n,c,t)})}function bctaiSendChatMessage(e,t,a,i){date_Time=formatAMPM(new Date);let n,c,o,s,r=t,l="",d=new FormData,g=e.getAttribute("data-ai-name"),p=e.getAttribute("data-nonce"),u=e.getAttribute("data-ai-avatar"),h=e.getAttribute("data-speech"),b=e.getAttribute("data-voice"),f=e.getAttribute("data-voice-error"),m=e.getAttribute("data-url"),v=e.getAttribute("data-post-id"),y=e.getAttribute("data-act-as"),x=e.getAttribute("data-user-id"),w=e.getAttribute("data-voice_service"),_=e.getAttribute("data-voice_language"),M=e.getAttribute("data-voice_name"),S=e.getAttribute("data-voice_device"),T=e.getAttribute("data-voice_speed"),C=e.getAttribute("data-voice_pitch"),A=document.getElementById("chatbot-contents");"widget"===a?(n=e.getElementsByClassName("bctai-bot-thinking")[0],c=e.getElementsByClassName("messages")[0],o="bctai-chat-user-message",s="bctai-chat-ai-message"):(n=e.getElementsByClassName("bctai-bot-thinking")[0],c=e.getElementsByClassName("messages")[0],o="bctai-user-message",s="bctai-ai-message"),n.style.display="block",A.style.padding="0px 0px 125px 10px";let k=bctaiescapeHtml(r.value);if(l+="<div style='width: 100%; float: right; margin-top:10px;'><div class='message right archive'><span class='name'><i class='cbiCon'></i></span><div class='bubble'><div class='txt'>",d.append("_wpnonce",p),d.append("act_as",y),d.append("post_id",v),d.append("user_id",x),d.append("url",m),"widget"===a?d.append("action","bctai_chatbox_message"):d.append("action","bctai_chat_shortcode_message"),void 0!==i){let e=URL.createObjectURL(i);l+='<audio src="'+e+'" controls="true"></audio>',d.append("audio",i,"bctai-chat-recording.wav")}else if(""!==k){l+=k.replace(/\n/g,"<br>");var L=JSON.stringify(k);console.log(L),d.append("message",k)}l+="</div></div><div class='date'>"+date_Time+"</div></div></div>",c.innerHTML+=l,c.scrollTop=c.scrollHeight;const R=new XMLHttpRequest;r.value="",bctaiSTTinput.style.height="100%",A.style.padding="0px 0px 107px 10px",R.open("POST",bctai_ajax_url,!0),R.send(d),R.onreadystatechange=function(e){if(4===R.readyState){var t="",i="",o="",s="",r="",l="";if(200===R.status){var d=this.responseText;if(console.log(d),""!==d)if(d=JSON.parse(d),console.log(d.data),A.style.padding="0px 0px 107px 10px",n.style.display="none","success"===d.status){i=d.data,s=d.ImgURL,o=d.url,l=d.cosine_score,console.log(o);let e=d.greeting_message;console.log(e),t+="<div style='width: 100%; float: left; margin-top:10px;'><div class='message left'><span class='name'><img src='"+u+"' height='40' width='40'></img><i class='cbiCon'></i> "+g+"</span><div class='bubble'>",o&&(r+="<a href=' "+o+"' target='_blank'>"+o+"</a>"),s&&(t+="<img src=' "+s+"' height='200' width='200'></img>"),t+="<div class='txt"+AIMsgIndex+"'></div>"}else i="이해에 도움이 되지 않았거나 추가적인 정보가 필요하신 경우, 언제든지 질문하거나 도움을 요청해 주십시오. 원하는 내용에 대해 자세히 설명해 드릴 수 있습니다!",t="<div style='width: 100%; float: left;margin-top:10px;'><div class='message left'><span class='name'><img src='"+u+"' height='40' width='40'></img><i class='cbiCon'></i> "+g+"</span><div class='bubble'><div class='txt"+AIMsgIndex+"'></div>"}else t="<div style='width: 100%; float: left; margin-top:10px;'><div class='message left'><span class='name'><img src='"+u+"' height='40' width='40'></img><i class='cbiCon'></i> "+g+"</span><div class='bubble'><div class='txt'>"+i+"</div>",i="Something went wrong5";if("null"!==i&&null!==i||(i="The model predicted a completion that begins with a stop sequence, resulting in no output. Consider adjusting your prompt or stop sequences."),""!==i&&""!==t)if(1==parseInt(h))if("google"===w){n.style.display="block",A.style.padding="0px 0px 125px 10px";let e=new FormData;e.append("type",a),e.append("nonce",p),e.append("action","bctai_google_speech"),e.append("language",_),e.append("name",M),e.append("device",S),e.append("speed",T),e.append("pitch",C),e.append("text",i);var m=new XMLHttpRequest;m.open("POST",bctai_ajax_url),m.onload=function(){var e=m.responseText;try{if(e=JSON.parse(e),"success"===e.status){var a=atob(e.audio);const o=new Array(a.length);for(let e=0;e<a.length;e++)o[e]=a.charCodeAt(e);const s=new Uint8Array(o),l=new Blob([s],{type:"audio/mp3"}),d=URL.createObjectURL(l);t+='<audio style="margin-top:2px;width: 100% " controls="controls"><source type="audio/mpeg" src="'+d+'"></audio>',t+="</div><div class='date'>"+date_Time+"</div></div>",A.style.padding="0px 0px 107px 10px",n.style.display="none",bctaiWriteMessage(c,t,r,i)}else{var o="Google: "+e.msg;if(A.style.padding="0px 0px 107px 10px",n.style.display="none",1!==parseInt(f))t+='<span style="width: 100%;display: block;font-size: 11px;">'+o+"</span>";else if(void 0!==d&&void 0!==d.log&&""!==d.log){var s=new FormData;s.append("nonce",p),s.append("log_id",d.log),s.append("message",o),s.append("action","bctai_speech_error_log");var l=new XMLHttpRequest;l.open("POST",bctai_ajax_url),l.send(s)}t+="</div><div class='date'>"+date_Time+"</div></div>",bctaiWriteMessage(c,t,r,i)}}catch(e){}},m.send(e)}else{alert(w);let e=new FormData;e.append("nonce",p),e.append("message",i),e.append("voice",b),e.append("action","bctai_text_to_speech"),n.style.display="block",A.style.padding="0px 0px 125px 10px";m=new XMLHttpRequest;m.open("POST",bctai_ajax_url),m.responseType="arraybuffer",m.onload=function(){A.style.padding="0px 0px 107px 10px",n.style.display="none";var e=new Blob([m.response],{type:"audio/mpeg"}),a=new FileReader;a.onload=function(){var a=this.result;try{var n=JSON.parse(a),o="ElevenLabs: "+n.detail.message;if(1!==parseInt(f))t+='<span style="width: 100%;display: block;font-size: 11px;">'+o+"</span>";else if(void 0!==d&&void 0!==d.log&&""!==d.log){var s=new FormData;s.append("nonce",p),s.append("log_id",d.log),s.append("message",o),s.append("action","bctai_speech_error_log");var l=new XMLHttpRequest;l.open("POST",bctai_ajax_url),l.send(s)}t+="</div><div class='date'>"+date_Time+"</div></div>",bctaiWriteMessage(c,t,r,i)}catch(a){var g=URL.createObjectURL(e);t+='<audio style="margin-top:2px;width: 100%" controls="controls"><source type="audio/mpeg" src="'+g+'"></audio>',t+="</div><div class='date'>"+date_Time+"</div></div>",bctaiWriteMessage(c,t,r,i)}},a.readAsText(e)},m.send(e)}else t+="</div><div class='date'>"+date_Time+"</div></div></div>",bctaiWriteMessage(c,t,r,i,l)}}}function welcom_MSG(){date_Time=formatAMPM(new Date);var e=document.getElementsByClassName("messages")[0];let t=document.getElementsByClassName("bctai-chatbox")[0],a=t.getAttribute("data-ai-avatar"),i=t.getAttribute("data-ai-name");var n="",c="",o=t.getAttribute("data-welcome-message"),s=o,r="";r+="<div style='width: 100%; float: left; margin-top:10px;'><div class='message left'><span class='name'><img src='"+a+"' height='40' width='40'></img><i class='cbiCon'></i>"+i+"</span><div class='bubble'><div class='txt"+AIMsgIndex+"'></div>",""!==s&&""!==r?(r+="</div><div class='date'>"+date_Time+"</div></div>",bctaiWriteMessage(e,r,n,s,c)):(r+="</div><div class='date'>"+date_Time+"</div></div>",bctaiWriteMessage(e,r,n,s))}function bctaiWriteMessage(e,t,a,i,n){e.innerHTML+=t;const c=i,o=document.querySelector(".chatbot-contents .message.left .bubble .txt"+AIMsgIndex);e.scrollTop=e.scrollHeight;for(var s=0;s<c.length;s++)(function(t){setTimeout(function(){o.innerHTML+=c[t],"\n"===c[t]&&(o.innerHTML+="<br>"),t===c.length-1&&(o.innerHTML+=a,n&&(o.innerHTML+="<br> (코사인유사도 : "+n+" %)"),e.scrollTop=e.scrollHeight)},50*t)})(s);AIMsgIndex++;s=0;""!==i&&(i=i.trim()),i=i.replace(/\n/g,"≈")}function bctaiMicEvent(e){if(e.classList.contains("bctai-recording"))e.innerHTML="",e.innerHTML=bctaiMicIcon,e.classList.remove("bctai-recording"),console.log(e),bctaistopChatRecording(e);else{let t=document.querySelectorAll(".bctai-recording");t&&t.length?alert("Please finish previous recording"):(e.innerHTML="",e.innerHTML=bctaiStopIcon,e.classList.add("bctai-recording"),bctaistartChatRecording())}}let bctaiMicIcon='<i class="fa-solid fa-microphone"></i>',bctaiStopIcon='<i class="fa-solid fa-record-vinyl"></i>';var bctaiChatStream,bctaiChatRec,bctaiInput,bctaiaudioContext,bctaiChatAudioContext=window.AudioContext||window.webkitAudioContext;let AIMsgIndex=0;var bctaiMicBtns=document.querySelectorAll(".bctai-mic-icon"),bctaiChatTyping=document.querySelectorAll(".bctai-chat-widget-typing"),bctaiChatSend=document.querySelectorAll(".btn-send_widget"),bctaiShortcodeTyping=document.querySelectorAll(".bctai-chat-shortcode-typing"),bctaiShortcodeSend=document.querySelectorAll(".btn-send"),chatbox=document.getElementById("bctai-chatbox");let data_stt_value="chatbox.getAttribute('data-stt-method');",bctaiSTTinput=document.getElementById("bctai-chat-widget-typing"),bctaichat_content=document.getElementById("chatbot-contents"),bctaichat_message=document.getElementById("messages");chatbox&&(document.addEventListener("DOMContentLoaded",function(){bctaiSTTinput.addEventListener("input",function(){this.style.height="auto",this.style.height=(this.scrollHeight>160?160:this.scrollHeight)+"px",this.scrollHeight<60?(bctaichat_content.style.padding="0px 0px 107px 10px",bctaichat_message.scrollTop=bctaichat_message.scrollHeight):this.scrollHeight<80?(bctaichat_content.style.padding="0px 0px 128px 10px",bctaichat_message.scrollTop=bctaichat_message.scrollHeight):this.scrollHeight<110?(bctaichat_content.style.padding="0px 0px 149px 10px",bctaichat_message.scrollTop=bctaichat_message.scrollHeight):this.scrollHeight<130?(bctaichat_content.style.padding="0px 0px 170px 10px",bctaichat_message.scrollTop=bctaichat_message.scrollHeight):this.scrollHeight<150?(bctaichat_content.style.padding="0px 0px 191px 10px",bctaichat_message.scrollTop=bctaichat_message.scrollHeight):(bctaichat_content.style.padding="0px 0px 212px 10px",bctaichat_message.scrollTop=bctaichat_message.scrollHeight)})}),welcom_MSG(),data_stt_value=chatbox.getAttribute("data-stt-method"));const recognition=new window.webkitSpeechRecognition,language="ko-KR";let isRecognizing=!1;recognition.continuous=!0,recognition.interimResults=!0,recognition.maxAlternatives=1e4,recognition.onstart=function(){isRecognizing=!0},recognition.onend=function(){isRecognizing=!1},recognition.onresult=(e=>{const t=e.results[0][0].transcript;bctaiSTTinput.value=t});var date_Time="";if(bctaiChatTyping&&bctaiChatTyping.length)for(let e=0;e<bctaiChatTyping.length;e++)bctaiChatTyping[e].addEventListener("keyup",function(t){if(!t.shiftKey||13!==t.which&&13!==t.keyCode){if(!t.shiftKey&&(13===t.which||13===t.keyCode)){let a=bctaiChatTyping[e].closest(".bctai-chatbox"),i=a.querySelectorAll(".bctai-chat-widget-typing")[0];bctaiSendChatMessage(a,i,"widget"),t.preventDefault()}}else;});if(bctaiChatSend&&bctaiChatSend.length)for(let e=0;e<bctaiChatSend.length;e++)bctaiChatSend[e].addEventListener("click",function(t){let a=bctaiChatSend[e].closest(".bctai-chatbox"),i=a.querySelectorAll(".bctai-chat-widget-typing")[0];bctaiSendChatMessage(a,i,"widget")});if(bctaiShortcodeTyping&&bctaiShortcodeTyping.length)for(let e=0;e<bctaiShortcodeTyping.length;e++)bctaiShortcodeTyping[e].addEventListener("keyup",function(t){if(!t.shiftKey||13!==t.which&&13!==t.keyCode){if((13===t.which||13===t.keyCode)&&!t.shiftKey){let t=bctaiShortcodeTyping[e].closest(".bctai-chatbox"),a=t.querySelectorAll(".bctai-chat-shortcode-typing")[0];bctaiSendChatMessage(t,a,"shortcode")}}else;});if(bctaiShortcodeSend&&bctaiShortcodeSend.length)for(let e=0;e<bctaiShortcodeSend.length;e++)bctaiShortcodeSend[e].addEventListener("click",function(t){let a=bctaiShortcodeSend[e].closest(".bctai-chatbox"),i=a.querySelectorAll(".bctai-chat-shortcode-typing")[0];bctaiSendChatMessage(a,i,"shortcode")});if(bctaiMicBtns&&bctaiMicBtns.length)for(let e=0;e<bctaiMicBtns.length;e++)bctaiMicBtns[e].addEventListener("click",function(){"Audio"==data_stt_value?bctaiMicEvent(bctaiMicBtns[e]):start(bctaiMicBtns[e])});jQuery(".btn-remove").click(function(){jQuery(".messages").empty(),welcom_MSG()});var isExpanded=!1;jQuery(".btn-fullscreen").click(function(){jQuery(this).find("i").toggleClass("fa-expand fa-compress"),isExpanded?jQuery(".high, .bctai_chat_widget_content").css({height:"",width:""}):(jQuery(".bctai_chat_widget_content").css({height:"690px",width:"1335px"}),jQuery(".high").css({height:"690px"})),isExpanded=!isExpanded}),jQuery(".btn-mail").click(function(){jQuery("#popup-dialog").dialog({modal:!0,width:"auto",resizable:!1,position:{my:"center",at:"center",of:window}}),jQuery(".ui-front").css("z-index","2001"),jQuery(".ui-dialog").css("z-index","2002"),jQuery(".ui-draggable").css("width","1066px"),jQuery(".ui-draggable").css("height","673px"),jQuery(".ui-draggable").css("background","#FFFFFF 0% 0% no-repeat padding-box"),jQuery(".ui-draggable").css("border-radius","30px"),jQuery(".ui-draggable").css("overflow","hidden"),jQuery(".ui-draggable").css("padding","20px"),jQuery(".ui-draggable").css("box-shadow","0px 0px 10px 3px gray"),jQuery(".ui-draggable-handle").css("background","none"),jQuery(".ui-draggable-handle").css("border","0px"),jQuery(".ui-draggable-handle").css("font-size","24px"),jQuery(".ui-draggable-handle").css("font-weight","900")}),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.Recorder=e()}}(function(){return function e(t,a,i){function n(o,s){if(!a[o]){if(!t[o]){var r="function"==typeof require&&require;if(!s&&r)return r(o,!0);if(c)return c(o,!0);var l=new Error("Cannot find module '"+o+"'");throw l.code="MODULE_NOT_FOUND",l}var d=a[o]={exports:{}};t[o][0].call(d.exports,function(e){var a=t[o][1][e];return n(a||e)},d,d.exports,e,t,a,i)}return a[o].exports}for(var c="function"==typeof require&&require,o=0;o<i.length;o++)n(i[o]);return n}({1:[function(e,t,a){"use strict";t.exports=e("./recorder").Recorder},{"./recorder":2}],2:[function(e,t,a){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var c=function(){function e(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}();Object.defineProperty(a,"__esModule",{value:!0}),a.Recorder=void 0;var o=e("inline-worker"),s=i(o),r=a.Recorder=function(){function e(t,a){var i=this;n(this,e),this.config={bufferLen:4096,numChannels:2,mimeType:"audio/wav"},this.recording=!1,this.callbacks={getBuffer:[],exportWAV:[]},Object.assign(this.config,a),this.context=t.context,this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=function(e){if(i.recording){for(var t=[],a=0;a<i.config.numChannels;a++)t.push(e.inputBuffer.getChannelData(a));i.worker.postMessage({command:"record",buffer:t})}},t.connect(this.node),this.node.connect(this.context.destination);var c={};this.worker=new s.default(function(){function e(e){h=e.sampleRate,b=e.numChannels,o()}function t(e){for(var t=0;t<b;t++)u[t].push(e[t]);p+=e[0].length}function a(e){for(var t=[],a=0;a<b;a++)t.push(s(u[a],p));var i=void 0;i=2===b?r(t[0],t[1]):t[0];var n=g(i),o=new Blob([n],{type:e});c.postMessage({command:"exportWAV",data:o})}function i(){for(var e=[],t=0;t<b;t++)e.push(s(u[t],p));c.postMessage({command:"getBuffer",data:e})}function n(){p=0,u=[],o()}function o(){for(var e=0;e<b;e++)u[e]=[]}function s(e,t){for(var a=new Float32Array(t),i=0,n=0;n<e.length;n++)a.set(e[n],i),i+=e[n].length;return a}function r(e,t){for(var a=e.length+t.length,i=new Float32Array(a),n=0,c=0;n<a;)i[n++]=e[c],i[n++]=t[c],c++;return i}function l(e,t,a){for(var i=0;i<a.length;i++,t+=2){var n=Math.max(-1,Math.min(1,a[i]));e.setInt16(t,n<0?32768*n:32767*n,!0)}}function d(e,t,a){for(var i=0;i<a.length;i++)e.setUint8(t+i,a.charCodeAt(i))}function g(e){var t=new ArrayBuffer(44+2*e.length),a=new DataView(t);return d(a,0,"RIFF"),a.setUint32(4,36+2*e.length,!0),d(a,8,"WAVE"),d(a,12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,b,!0),a.setUint32(24,h,!0),a.setUint32(28,4*h,!0),a.setUint16(32,2*b,!0),a.setUint16(34,16,!0),d(a,36,"data"),a.setUint32(40,2*e.length,!0),l(a,44,e),a}var p=0,u=[],h=void 0,b=void 0;c.onmessage=function(c){switch(c.data.command){case"init":e(c.data.config);break;case"record":t(c.data.buffer);break;case"exportWAV":a(c.data.type);break;case"getBuffer":i();break;case"clear":n()}}},c),this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels}}),this.worker.onmessage=function(e){var t=i.callbacks[e.data.command].pop();"function"==typeof t&&t(e.data.data)}}return c(e,[{key:"record",value:function(){this.recording=!0}},{key:"stop",value:function(){this.recording=!1}},{key:"clear",value:function(){this.worker.postMessage({command:"clear"})}},{key:"getBuffer",value:function(e){if(e=e||this.config.callback,!e)throw new Error("Callback not set");this.callbacks.getBuffer.push(e),this.worker.postMessage({command:"getBuffer"})}},{key:"exportWAV",value:function(e,t){if(t=t||this.config.mimeType,e=e||this.config.callback,!e)throw new Error("Callback not set");this.callbacks.exportWAV.push(e),this.worker.postMessage({command:"exportWAV",type:t})}}],[{key:"forceDownload",value:function(e,t){var a=(window.URL||window.webkitURL).createObjectURL(e),i=window.document.createElement("a");i.href=a,i.download=t||"output.wav";var n=document.createEvent("Event");n.initEvent("click",!0,!0),i.dispatchEvent(n)}}]),e}();a.default=r},{"inline-worker":3}],3:[function(e,t,a){"use strict";t.exports=e("./inline-worker")},{"./inline-worker":4}],4:[function(e,t,a){(function(e){"use strict";var a=function(){function e(e,t){for(var a in t){var i=t[a];i.configurable=!0,i.value&&(i.writable=!0)}Object.defineProperties(e,t)}return function(t,a,i){return a&&e(t.prototype,a),i&&e(t,i),t}}(),i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=!!(e===e.window&&e.URL&&e.Blob&&e.Worker),c=function(){function t(a,c){var o=this;if(i(this,t),n){var s=a.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],r=e.URL.createObjectURL(new e.Blob([s],{type:"text/javascript"}));return new e.Worker(r)}this.self=c,this.self.postMessage=function(e){setTimeout(function(){o.onmessage({data:e})},0)},setTimeout(function(){a.call(c)},0)}return a(t,{postMessage:{value:function(e){var t=this;setTimeout(function(){t.self.onmessage({data:e})},0)}}}),t}();t.exports=c}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1])(1)});